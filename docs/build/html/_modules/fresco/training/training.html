<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fresco.training.training &mdash; FrESCO 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            FrESCO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">fresco</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">FrESCO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fresco.training.training</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fresco.training.training</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Module for training a deep learning model&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="c1"># import torch.nn.functional as F</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span>

<span class="kn">from</span> <span class="nn">torch.profiler</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">record_function</span><span class="p">,</span> <span class="n">ProfilerActivity</span><span class="p">,</span> <span class="n">schedule</span>


<div class="viewcode-block" id="trace_handler"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.trace_handler">[docs]</a><span class="k">def</span> <span class="nf">trace_handler</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">key_averages</span><span class="p">(</span><span class="n">group_by_stack_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;self_cpu_time_total&#39;</span><span class="p">,</span> <span class="n">row_limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">export_chrome_trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trace_</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">step_num</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelTrainer"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer">[docs]</a><span class="k">class</span> <span class="nc">ModelTrainer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Training class definition.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        savepath (str): Path for saving models and metrics.</span>
<span class="sd">        epochs (int): Maximum number of epochs to train for.</span>
<span class="sd">        patience_stop (int): Patience stopping criteria.</span>
<span class="sd">        keywords (bool): Use keywords model.</span>
<span class="sd">        tasks (list): List of tasks, each task is a string.</span>
<span class="sd">        n_task (bool): Are we using ntask?</span>

<span class="sd">        model (Model): Model definition, declared and initialized in the caller.</span>
<span class="sd">        dw (DataHandler): DataHandler class, initialized in the caller.</span>
<span class="sd">        device (torch.device): CUDA or CPU.</span>
<span class="sd">        best_loss (float): Best validation loss scores.</span>
<span class="sd">        patience_ctr (int): Patience counter.</span>
<span class="sd">        loss (torch.tensor): Loss value on device.</span>

<span class="sd">        y_preds (list): List of predictions, usually logits as torch.tensor.</span>
<span class="sd">        y_trues (list): List of ints with ground truth values.</span>

<span class="sd">        multilabel (bool): Multilabel classification?</span>
<span class="sd">        abstain (bool): Use the deep abstaining classifier?</span>
<span class="sd">        mixed_precision (bool): Use PyTorch automatic mixed precision?</span>

<span class="sd">        opt (torch.optimizer): Optimizer for training.</span>
<span class="sd">        reduction (str): Type of reduction for the loss function.</span>

<span class="sd">        loss_funs (dict): Dictionary of torch loss functions for training each task.</span>

<span class="sd">        class_weights (list): List of floats for class weighting schemes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw_args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">class_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;savedmodels/&#39;</span> <span class="o">+</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;save_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;data_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;fold_number&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold</span> <span class="o">=</span> <span class="n">fold</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">savepath</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savename</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;save_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fold</span><span class="si">}</span><span class="s2">.h5&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_weights</span> <span class="o">=</span> <span class="n">class_weights</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;abstain_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;abstain_flag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;abstain_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;ntask_flag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;mixed_precision&#39;</span><span class="p">]</span>

        <span class="c1"># setup loss function</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">reduction</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reduction</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clc</span> <span class="o">=</span> <span class="n">clc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;data_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weights</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;multilabel&#39;</span><span class="p">]</span>
            <span class="c1"># setup class weights</span>
            <span class="k">if</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;class_weights&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;class_weights&#39;</span><span class="p">],</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                    <span class="n">weights_task</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">task</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">weights_task</span><span class="p">,</span>
                                <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weights_task</span><span class="p">,</span>
                                <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patience_ctr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience_stop</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s1">&#39;train_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;batch_per_gpu&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dw</span><span class="o">.</span><span class="n">train_size</span><span class="p">))</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dw</span><span class="o">.</span><span class="n">train_size</span><span class="p">))</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">dw</span><span class="o">.</span><span class="n">val_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">val_size</span> <span class="o">=</span> <span class="n">dw</span><span class="o">.</span><span class="n">val_size</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># train is used for val</span>
                <span class="n">val_size</span> <span class="o">=</span> <span class="n">dw</span><span class="o">.</span><span class="n">train_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">val_size</span><span class="p">))</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">val_size</span><span class="p">))</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>

<div class="viewcode-block" id="ModelTrainer.get_ys"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.get_ys">[docs]</a>    <span class="k">def</span> <span class="nf">get_ys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get ground truth and y_predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            logits (list): List of logits.</span>
<span class="sd">            y (dict): Dictionary of numpy ndarrays, with tasks as keys.</span>
<span class="sd">            idx (int): Index in the enumerated DataLoader.</span>

<span class="sd">        Post-condition:</span>
<span class="sd">            self.y_trues and self.y_preds are populated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span>
            <span class="n">trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span>
            <span class="n">trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:</span>
                <span class="n">preds</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span><span class="p">:</span>
                    <span class="n">trues</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trues</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preds</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span><span class="p">:</span>
                    <span class="n">trues</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trues</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelTrainer.profile_fit_model"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.profile_fit_model">[docs]</a>    <span class="k">def</span> <span class="nf">profile_fit_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main training loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loader (torch.DataLoader): Initialized and populated in the calling function.</span>
<span class="sd">            dac (Abstention): Abstention class, deep abstaining classifier class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">dac</span><span class="o">.</span><span class="n">ntask_filter</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">profile</span><span class="p">(</span>
                <span class="n">activities</span><span class="o">=</span><span class="p">[</span><span class="n">ProfilerActivity</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span> <span class="n">ProfilerActivity</span><span class="o">.</span><span class="n">CUDA</span><span class="p">],</span>
                <span class="n">schedule</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span>
                    <span class="n">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">warmup</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">active</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                <span class="n">on_trace_ready</span><span class="o">=</span><span class="n">trace_handler</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
                        <span class="n">batch_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">batch_len</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_len</span><span class="p">)</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_clc_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

                    <span class="c1"># backprop</span>
                    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">training time </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training loss: </span><span class="si">{</span><span class="n">loss_np</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.fit_model"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.fit_model">[docs]</a>    <span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main training loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loader (torch.DataLoader): Initialized and populated in the calling function.</span>
<span class="sd">            val_loader (torch.DataLoader): Initialized and populated in the calling function. Can be None, then training is used for validation scores.</span>
<span class="sd">            dac (Abstention): Abstention class, deep abstaining classifier class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">best_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">model_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">dac</span><span class="o">.</span><span class="n">ntask_filter</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
                        <span class="n">batch_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">batch_len</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_len</span><span class="p">)</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_clc_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

                <span class="c1"># backprop</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">training time </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">loss_np</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training loss: </span><span class="si">{</span><span class="n">loss_np</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">train_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">(</span><span class="n">dac</span><span class="p">)</span>
            <span class="n">train_scores</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_np</span>
            <span class="n">all_scores</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_train_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_scores</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> validation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">stop</span><span class="p">,</span> <span class="n">val_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">val_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="n">dac</span><span class="p">)</span>
            <span class="n">all_scores</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_val_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_scores</span>

            <span class="k">if</span> <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_loss</span><span class="p">:</span>
                <span class="n">best_loss</span> <span class="o">=</span> <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">model_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">_scores_fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fold</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savepath</span> <span class="o">+</span> <span class="n">scores</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_scores</span><span class="p">,</span> <span class="n">f_out</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Model training hit max epochs, not converged&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">savename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">_scores_fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fold</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savepath</span> <span class="o">+</span> <span class="n">scores</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_scores</span><span class="p">,</span> <span class="n">f_out</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.train_metrics"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.train_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">train_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute per-epoch metrics during training.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">pred_idxs</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">compute_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">ntask_scores</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">compute_ntask_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">][</span><span class="s1">&#39;ntask_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntask_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">][</span><span class="s1">&#39;ntask_abs_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntask_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">_trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>
            <span class="n">_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
                <span class="n">_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_trues</span><span class="p">)</span>
                <span class="n">_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_preds</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">_true</span><span class="p">[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                 <span class="n">_pred</span><span class="p">[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                 <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">_true</span><span class="p">[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                 <span class="n">_pred</span><span class="p">[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                 <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;abs_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abs_rates</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_abs&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">_trues</span><span class="p">,</span> <span class="n">_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">_trues</span><span class="p">,</span> <span class="n">_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>

        <span class="c1"># print/write stats</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">print_abs_header</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">dac</span><span class="o">.</span><span class="n">print_abs_stats</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">],</span>
                                    <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">],</span>
                                    <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;abs_rate&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;task&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;micro&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;macro&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;ntask&#39;</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ntask_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="o">+</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ntask_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ntask_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="ModelTrainer.score"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">val_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Score a model during training.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch (int): Epoch number.</span>
<span class="sd">            val_loader (torch.dataLoader): DataLoader class with PathReports.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class. Are we using the dac?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">val_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;abs_stop_vals&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;val_micro&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_macro&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">abs_scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># abs_stop_vals = []</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">[</span><span class="n">task</span><span class="p">][:]</span>

        <span class="k">if</span> <span class="n">val_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">data_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="n">dac</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># score the training set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">pred_idxs</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">compute_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">ntask_scores</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">compute_ntask_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">][</span><span class="s1">&#39;ntask_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntask_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;ntask&#39;</span><span class="p">][</span><span class="s1">&#39;ntask_abs_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntask_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">_trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>
            <span class="n">_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
                <span class="n">score</span><span class="p">,</span> <span class="n">_abs_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_scores</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_trues</span><span class="p">)[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                         <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_preds</span><span class="p">)[</span><span class="n">pred_idxs</span><span class="p">[</span><span class="n">task</span><span class="p">]],</span>
                                                         <span class="n">task</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span>
                <span class="n">abs_scores</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abs_scores</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_scores</span><span class="p">(</span><span class="n">_trues</span><span class="p">,</span> <span class="n">_preds</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

            <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">alpha_scale</span><span class="p">,</span> <span class="n">abs_stop_vals</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">modify_alphas</span><span class="p">(</span><span class="n">abs_scores</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">ntask_scale</span><span class="p">,</span> <span class="n">ntask_stop_val</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">modify_ntask_alpha</span><span class="p">()</span>
                <span class="n">abs_stop_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ntask_stop_val</span><span class="p">)</span>

            <span class="n">stop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_metrics</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span>
                                        <span class="n">epoch</span><span class="p">,</span>
                                        <span class="n">abs_stop_vals</span><span class="p">,</span>
                                        <span class="n">dac</span><span class="p">)</span>
            <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;abs_stop_vals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abs_stop_vals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_metrics</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">epoch</span><span class="p">)</span>

        <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
        <span class="n">micro</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
        <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;val_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>
        <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;val_micro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">micro</span><span class="p">)</span>

        <span class="c1"># print/write stats</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">abs_scores</span><span class="o">=</span><span class="n">abs_scores</span><span class="p">,</span>
                               <span class="n">dac</span><span class="o">=</span><span class="n">dac</span><span class="p">,</span> <span class="n">stop_vals</span><span class="o">=</span><span class="n">abs_stop_vals</span><span class="p">,</span> <span class="n">alpha_scale</span><span class="o">=</span><span class="n">alpha_scale</span><span class="p">,</span>
                               <span class="n">ntask_stop_val</span><span class="o">=</span><span class="n">ntask_stop_val</span><span class="p">,</span> <span class="n">ntask_alpha_scale</span><span class="o">=</span><span class="n">ntask_scale</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">abs_scores</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">abs_stop_vals</span><span class="p">,</span> <span class="n">alpha_scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="c1"># update alphas</span>
            <span class="n">val_scores</span><span class="p">[</span><span class="s1">&#39;abs_stop_vals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abs_stop_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated ntask alpha: </span><span class="si">{</span><span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span><span class="si">:</span><span class="s2">0.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated alphas: &#39;</span><span class="p">,</span> <span class="n">dac</span><span class="o">.</span><span class="n">alphas</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stop</span><span class="p">,</span> <span class="n">val_scores</span></div>

    <span class="k">def</span> <span class="nf">_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Score data_loader for validation.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_loader (torch.DataLoader): Typically the validation split. If None, then use the training set.</span>
<span class="sd">            dac (Abstention): Abstention class, deep abstaining classifier class.</span>

<span class="sd">        Post condition:</span>
<span class="sd">            self.val_preds and self.val_trues are updated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scores (dict): Dictionary where keys are tasks, and values are dictionaries with keys val_loss, macro, and micro.</span>
<span class="sd">            abs_scores (list): List of abstention scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">ntask_filter</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">):</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clc</span><span class="p">:</span>
                        <span class="n">batch_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">batch_len</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_len</span><span class="p">)</span>
                        <span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_clc_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">dac</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dac</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span>

<div class="viewcode-block" id="ModelTrainer.compute_scores"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.compute_scores">[docs]</a>    <span class="k">def</span> <span class="nf">compute_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">y_true</span><span class="p">,</span>
                       <span class="n">y_pred</span><span class="p">,</span>
                       <span class="n">task</span><span class="p">,</span>
                       <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute macro/micro scores per task.</span>

<span class="sd">        Args:</span>
<span class="sd">            y_true (list): List of ground truth labels (as int). It is a list of lists for n_tasks &gt; 1.</span>
<span class="sd">            y_pred (list): List of predicted classes (as list of tensors). It is a list of lists for n_tasks &gt; 1.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class.</span>
<span class="sd">            idx (int): Indexing self.tasks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scores: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_y_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_pred</span><span class="p">]</span>
        <span class="n">micro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">_y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">micro</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">_y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macro</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">abs_scores</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dac.compute_abs_scores(y_true, _y_pred, tasks)</span>
            <span class="n">abs_scores</span><span class="p">[</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macro</span>
            <span class="n">abs_scores</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">micro</span>
            <span class="n">abs_scores</span><span class="p">[</span><span class="s1">&#39;stop_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macro</span>
            <span class="n">abs_scores</span><span class="p">[</span><span class="s1">&#39;abs_rates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abs_rates</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">_abs&quot;</span><span class="p">]</span>
            <span class="n">abs_scores</span><span class="p">[</span><span class="s1">&#39;abs_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">_y_pred</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abs_scores</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">abs_scores</span></div>

<div class="viewcode-block" id="ModelTrainer.output_scores"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.output_scores">[docs]</a>    <span class="k">def</span> <span class="nf">output_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">scores</span><span class="p">,</span>
                      <span class="n">abs_scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">stop_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">alpha_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">ntask_stop_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">ntask_alpha_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print stats to the terminal.</span>

<span class="sd">        Args:</span>
<span class="sd">            scores (dict): Dictionary of metrics, with tasks as keys and metrics as values.</span>
<span class="sd">            dac (Abstaining): Abstaining Classifier class.</span>
<span class="sd">            stop_vals (list): List of stopping criteria.</span>
<span class="sd">            alpha_scale (dict): Dictionary of scaling values for the dac, with tasks as keys.</span>
<span class="sd">            ntask_stop_val (float): Stopping criterion for ntask.</span>
<span class="sd">            ntask_alpha_scale (float): Scaling factor for ntask alpha.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">abs_micros</span> <span class="o">=</span> <span class="p">[</span><span class="n">abs_scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">]</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">write_abs_stats</span><span class="p">(</span><span class="n">abs_micros</span><span class="p">)</span>

            <span class="n">dac</span><span class="o">.</span><span class="n">print_abs_tune_header</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
                <span class="n">dac</span><span class="o">.</span><span class="n">print_abs_tune_stats</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">],</span>
                                         <span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">],</span> <span class="n">dac</span><span class="o">.</span><span class="n">min_acc</span><span class="p">[</span><span class="n">task</span><span class="p">],</span>
                                         <span class="n">abs_scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;abs_rates&#39;</span><span class="p">],</span> <span class="n">dac</span><span class="o">.</span><span class="n">max_abs</span><span class="p">[</span><span class="n">task</span><span class="p">],</span>
                                         <span class="n">dac</span><span class="o">.</span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha_scale</span><span class="p">[</span><span class="n">task</span><span class="p">],</span>
                                         <span class="n">stop_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># print ntask stats</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="n">dac</span><span class="o">.</span><span class="n">print_abs_tune_stats</span><span class="p">(</span><span class="s1">&#39;ntask&#39;</span><span class="p">,</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_acc</span><span class="p">,</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_acc</span><span class="p">,</span>
                                         <span class="n">dac</span><span class="o">.</span><span class="n">ntask_min_acc</span><span class="p">,</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_abs_rate</span><span class="p">,</span>
                                         <span class="n">dac</span><span class="o">.</span><span class="n">ntask_max_abs</span><span class="p">,</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span><span class="p">,</span>
                                         <span class="n">ntask_alpha_scale</span><span class="p">,</span> <span class="n">ntask_stop_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;task&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;micro&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;macro&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.compute_loss"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.compute_loss">[docs]</a>    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute forward pass and loss function.</span>

<span class="sd">        Args:</span>
<span class="sd">            logits (torch.tensor): Logits.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class.</span>
<span class="sd">            ntask_abs (float): Probability of abstaining on the entire document.</span>

<span class="sd">        Returns:</span>
<span class="sd">            loss (torch.tensor): Float tensor.</span>

<span class="sd">        Post-condition:</span>
<span class="sd">            y_preds and y_trues are populated.</span>
<span class="sd">            loss is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">ntask_abs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">get_ntask_filter</span><span class="p">(</span><span class="n">ntask_abs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_tasks</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">ntask_abs_prob</span><span class="o">=</span><span class="n">ntask_abs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>  <span class="c1"># just the dac</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># nothing fancy</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">](</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ntask_abs</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="c1"># average over all tasks</span>
        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.compute_val_loss"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.compute_val_loss">[docs]</a>    <span class="k">def</span> <span class="nf">compute_val_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute forward pass and loss function.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (torch.tensor): Iterate from DataLoader.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class.</span>
<span class="sd">            ntask_abs (float): Probability of abstaining on the entire document.</span>

<span class="sd">        Returns:</span>
<span class="sd">            loss (torch.tensor): Float tensor.</span>

<span class="sd">        Post-condition:</span>
<span class="sd">            y_preds and y_trues are populated.</span>
<span class="sd">            loss is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">ntask_abs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">get_ntask_filter</span><span class="p">(</span><span class="n">ntask_abs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_tasks</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">ntask_abs_prob</span><span class="o">=</span><span class="n">ntask_abs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>  <span class="c1"># just the dac</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># nothing fancy</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funs</span><span class="p">[</span><span class="n">task</span><span class="p">](</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multilabel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ntask_abs</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="c1"># average over all tasks</span>
        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.compute_clc_loss"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.compute_clc_loss">[docs]</a>    <span class="k">def</span> <span class="nf">compute_clc_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute forward pass and case level loss function.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (torch.tensor): Iterate from DataLoader.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class.</span>
<span class="sd">            ntask_abs (float): Probability of abstaining on the entire document.</span>

<span class="sd">        Returns:</span>
<span class="sd">            loss (torch.tensor): Float tensor.</span>

<span class="sd">        Post-condition:</span>
<span class="sd">            y_preds and y_trues are populated.</span>
<span class="sd">            loss is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">y_trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span>
            <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_trues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_trues</span>
            <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_preds</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">ntask_abs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idxs</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">get_ntask_filter</span><span class="p">(</span><span class="n">ntask_abs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="n">y_true</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idxs</span><span class="p">]</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_tasks</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ntask_abs_prob</span><span class="o">=</span><span class="n">ntask_abs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>  <span class="c1"># just the dac</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># nothing fancy</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
            <span class="n">y_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ntask_abs</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="c1"># average over all tasks</span>
        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.compute_clc_val_loss"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.compute_clc_val_loss">[docs]</a>    <span class="k">def</span> <span class="nf">compute_clc_val_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute forward pass and loss function for case level context.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (torch.tensor): Iterate from DataLoader.</span>
<span class="sd">            dac (Abstention): Deep abstaining classifier class.</span>
<span class="sd">            ntask_abs (float): Probability of abstaining on the entire document.</span>

<span class="sd">        Returns:</span>
<span class="sd">            loss (torch.tensor): Float tensor.</span>

<span class="sd">        Post-condition:</span>
<span class="sd">            y_preds and y_trues are populated.</span>
<span class="sd">            loss is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>
        <span class="n">batch_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_len</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">batch_len</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">ntask_abs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idxs</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dac</span><span class="o">.</span><span class="n">get_ntask_filter</span><span class="p">(</span><span class="n">ntask_abs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="n">y_true</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">idxs</span><span class="p">]</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">dac</span><span class="o">.</span><span class="n">ntask_tasks</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ntask_abs_prob</span><span class="o">=</span><span class="n">ntask_abs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>  <span class="c1"># just the dac</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">dac</span><span class="o">.</span><span class="n">abstention_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># nothing fancy</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">val_trues</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_preds</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntask</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dac</span><span class="o">.</span><span class="n">ntask_alpha</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ntask_abs</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="c1"># average over all tasks</span>
        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelTrainer.stop_metrics"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.stop_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">stop_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">stop_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute stop metrics.</span>

<span class="sd">        Compute stop metrics for normal (val loss + patience) or DAC (stop metric) training.</span>

<span class="sd">        Args:</span>
<span class="sd">            loss (torch.tensor): Float tensor, val loss value at the current epoch.</span>
<span class="sd">            epoch (int): Epoch counter.</span>
<span class="sd">            stop_metrics (dict): Dictionary of floats for abstention rates and accuracy.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If abstaining:</span>
<span class="sd">                stop_val (float): DAC stopping criterion.</span>
<span class="sd">                stop (bool): Stop or go?</span>
<span class="sd">            Otherwise:</span>
<span class="sd">                stop_val (float): Best val loss.</span>
<span class="sd">                stop (bool): Stop or go?</span>

<span class="sd">        Post-condition:</span>
<span class="sd">        If not abstaining, patience counter is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstain</span><span class="p">:</span>
            <span class="n">stop_val</span> <span class="o">=</span> <span class="n">dac</span><span class="o">.</span><span class="n">check_abs_stop_metric</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stop_metrics</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">stop_val</span> <span class="o">&lt;</span> <span class="n">dac</span><span class="o">.</span><span class="n">stop_limit</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stopping criterion reached: </span><span class="si">{</span><span class="n">stop_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> &lt; </span><span class="si">{</span><span class="n">dac</span><span class="o">.</span><span class="n">stop_limit</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stopping criterion not reached: </span><span class="si">{</span><span class="n">stop_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="n">dac</span><span class="o">.</span><span class="n">stop_limit</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> val loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="s2">, best val loss: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># use patience based on val loss</span>
            <span class="k">if</span> <span class="n">loss</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="o">=</span> <span class="n">loss</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patience_ctr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patience_ctr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience_ctr</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience_stop</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patience counter is at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patience_ctr</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patience_stop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stop_val</span></div>

<div class="viewcode-block" id="ModelTrainer.print_stats"><a class="viewcode-back" href="../../../fresco.training.html#fresco.training.training.ModelTrainer.print_stats">[docs]</a>    <span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print macro/micro scores to stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Adam Spannaus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>